
# Process

## Current process of creating source csv files

The input data is a series of csv files for each department (latest takes precedence):

* Any other ??
* Analytics old -> nothing
* Sitemap old -> new
* Manual old -> new
* Furls old -> old
* Whitehall old -> new

We start with a blank set and patch each of these files on top of each other.

1. Sanitizes url:

* space encoding
* removing all spaces
* &amp; -> &
* removes extra close parentheses
* encodes commas

2. skips blanks or invalid old urls

* has to have a scheme and pass URI.parse

3. deduping

4. remaps

* admin urls -> public urls
* ensures that gov.uk urls use https
* if invalid new url, then 410s

5. folding
6. sort -u

## Possible command line chain

* fetch CSVs:
  * Any Other
  * Analytics
  * Sitemap
  * Manual mappings
  * Furls
  * Harvester
  * Whitehall
  * Patches
* concat together in from least reliable to most reliable (need fetch)
* sanitize (1 above) (split out from munge)
* skip blank or invalid old (split out from munge)
* tidy --overwrite (also c14n's) (Paul)
* admin -> public (split out from munge)
* govuk -> https (easy)
* 410 if invalid new (easy)
* fold (following redirects in the file) (split out from munge?)
* sort -u (easy)

## Current process for munging Scotland (very manual)

* munge, then remove all rows where the old url has a query string, then remove any that have mailto, then tidy

# Redirector fetch process

## How to set up a new department

To be completed.

## How to run the fetch scripts

### Terms

* *Old url:* The url as it existed on the original site. eg `http://decc.gov.uk/path-to-something`
* *New url:* The new GOV.UK url we want to redirect to. eg `http://gov.uk/path-to-the-new-version`
* *Admin url:* The admin url equivalent for the new url. eg `http://whitehall-admin.production.alphagov.co.uk/government/admin/detailed-guides/12345`

### The process

#### Download a document mappings file

This file is generated each night at 2am from the latest production data, and serves two purposes:

* The providing of mappings from "old urls" to "new urls"
* The conversion of "admin urls" to publicly-consumable "new urls"

If you have an old CSV file, ensure you have deleted it - the below process will download it automatically.

#### Generate the redirects

Ensure that the source google doc is set up and the most recent version is published to CSV (ask Robin or Pete to do this.)

From the root of the project, run `./munge/generate-redirects.sh -w data/whitelist.txt -s data/sites.txt -u user:pass <department>`

eg `./munge/generate-redirects.sh -w data/whitelist.txt -s data/sites.txt -u foo:bar decc`

This will regenerate files we keep checked in in `data/mappings/`. Any warnings or errors in the url formats are sent to $stderr in the following form:

    error url,error name,source file url,source file row number

This script will also run the `./tools/tidy_mappings.pl` script for you.

*NOTE:* The googledoc files are fetched and stored temporarily as part of this process. If you want to generate the redirects without fetching the googledocs again, then use the `-n` switch.

The `-u` switch is used to fetch the document mappings from Whitehall. The credentials are generally known to Whitehall team members: if in doubt, ask.

#### View changes and check in

Use `git diff` to view the changes made to the file, and check through the changes with Robin or Pete before committing them.

It's useful to search through for any `301s` that are being removed as a sanity check, try `git diff` then type `/^-.*301$`.

#### Check the redirect build

If there are warnings about an unstable `redirector` build, there will be errors in the redirect files.

Look [here](http://ci.alphagov.co.uk/view/Transition/job/redirector/lastSuccessfulBuild/artifact/dist/) for any files named `<department>_incorrect.txt` (eg `decc_og_incorrect.txt`) - this will give you the list of links to fix in the source google doc.

#### Deploy

The redirector is deployed to production in a similar way to other projects.

You can still deploy the redirector on an unstable build as the offending links will not be generated by the redirector. Don't deploy if the main `redirector` or `redirector-deploy` fails, or if the `redirector-integration-subset` build fails.
